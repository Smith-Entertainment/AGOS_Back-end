<?xml version="1.0" encoding="UTF-8"?><!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd"><html xmlns="http://www.w3.org/1999/xhtml" lang="pt"><head><meta http-equiv="Content-Type" content="text/html;charset=UTF-8"/><link rel="stylesheet" href="../jacoco-resources/report.css" type="text/css"/><link rel="shortcut icon" href="../jacoco-resources/report.gif" type="image/gif"/><title>ObraService.java</title><link rel="stylesheet" href="../jacoco-resources/prettify.css" type="text/css"/><script type="text/javascript" src="../jacoco-resources/prettify.js"></script></head><body onload="window['PR_TAB_WIDTH']=4;prettyPrint()"><div class="breadcrumb" id="breadcrumb"><span class="info"><a href="../jacoco-sessions.html" class="el_session">Sessions</a></span><a href="../index.html" class="el_report">Obras-Java</a> &gt; <a href="index.source.html" class="el_package">AGOS.AGOS.services</a> &gt; <span class="el_source">ObraService.java</span></div><h1>ObraService.java</h1><pre class="source lang-java linenums">package AGOS.AGOS.services;

import AGOS.AGOS.dto.ObraDTO;
import AGOS.AGOS.entity.Meses;
import AGOS.AGOS.entity.Obra;
import AGOS.AGOS.entity.Periodo;
import AGOS.AGOS.repository.ObraRepository;
import AGOS.AGOS.repository.PeriodoRepository;
import org.springframework.beans.factory.annotation.Autowired;
import org.springframework.stereotype.Service;
import org.springframework.transaction.annotation.Transactional;

import java.time.LocalDate;
import java.time.YearMonth;
import java.time.format.DateTimeFormatter;
import java.time.format.TextStyle;
import java.util.ArrayList;
import java.util.List;
import java.util.Locale;

import static org.hibernate.validator.internal.util.Contracts.assertNotNull;

<span class="fc" id="L23">@Service</span>
<span class="fc" id="L24">public class ObraService {</span>

    @Autowired
    public PeriodoRepository periodoRepository;

    @Autowired
    public ObraRepository obraRepository;

    @Transactional
    public void createObra(ObraDTO obraDTO) {
<span class="fc" id="L34">        validateObraDTO(obraDTO);</span>

<span class="fc" id="L36">        Obra obra = DTOToEntity(obraDTO);</span>
<span class="fc" id="L37">        obraRepository.save(obra);</span>

<span class="fc" id="L39">    }</span>

    @Transactional
    public void updateObra(Long obraId, ObraDTO obraDTO) {
<span class="fc" id="L43">        validateObraDTO(obraDTO);</span>

<span class="fc" id="L45">        Obra existingObra = obraRepository.findById(obraId)</span>
<span class="pc" id="L46">                .orElseThrow(() -&gt; new IllegalArgumentException(&quot;Obra não encontrada&quot;));</span>

<span class="fc" id="L48">        updateObraFromDTO(existingObra, obraDTO);</span>
<span class="fc" id="L49">        obraRepository.save(existingObra);</span>
<span class="fc" id="L50">    }</span>

    private void validateObraDTO(ObraDTO obraDTO) {
<span class="fc" id="L53">        assertNotBlank(obraDTO.getTitulo(), &quot;Título não pode estar em branco&quot;);</span>
<span class="fc" id="L54">        assertNotBlank(obraDTO.getBairro(), &quot;Bairro não pode estar em branco&quot;);</span>
<span class="fc" id="L55">        assertNotBlank(obraDTO.getRua(), &quot;Rua não pode estar em branco&quot;);</span>
<span class="fc" id="L56">        assertNotBlank(obraDTO.getLicitacao(), &quot;Licitacao não pode estar em branco&quot;);</span>
<span class="fc" id="L57">        assertNotNull(obraDTO.getValorEdital(), &quot;Licitacao não pode estar em branco&quot;);</span>
<span class="fc" id="L58">        assertNotNull(obraDTO.getTipoObra(), &quot;Tipo obra nao pode ser nulo&quot;);</span>
<span class="fc" id="L59">    }</span>

    private void assertNotBlank(String value, String message) {
<span class="pc bpc" id="L62" title="1 of 2 branches missed.">        assert !value.isBlank() : message;</span>
<span class="fc" id="L63">    }</span>

    private Obra DTOToEntity(ObraDTO obraDTO) {
<span class="fc" id="L66">        Obra obra = new Obra();</span>
<span class="fc" id="L67">        obra.setTitulo(obraDTO.getTitulo());</span>
<span class="fc" id="L68">        obra.setFoto(obraDTO.getFoto());</span>
<span class="fc" id="L69">        obra.setLicitacao(obraDTO.getLicitacao());</span>
<span class="fc" id="L70">        obra.setDataCertame(obraDTO.getDataCertame());</span>
<span class="fc" id="L71">        obra.setValorEdital(obraDTO.getValorEdital());</span>
<span class="fc" id="L72">        obra.setBairro(obraDTO.getBairro());</span>
<span class="fc" id="L73">        obra.setRua(obraDTO.getRua());</span>
<span class="fc" id="L74">        obra.setNumeroEndereco(obraDTO.getNumero());</span>
<span class="fc" id="L75">        obra.setValorContratado(obraDTO.getValorContratado());</span>
<span class="fc" id="L76">        obra.setDataInicio(obraDTO.getDataInicio());</span>
<span class="fc" id="L77">        obra.setDataTermino(obraDTO.getDataTermino());</span>
<span class="fc" id="L78">        obra.setNumeroContrato(obraDTO.getNumeroContrato());</span>
<span class="fc" id="L79">        obra.setEmpresaContratada(obraDTO.getEmpresaContratada());</span>
<span class="fc" id="L80">        obra.setSituacao(obraDTO.getSituacao());</span>
<span class="fc" id="L81">        obra.setTipoObra(obraDTO.getTipoObra());</span>
<span class="fc" id="L82">        return obra;</span>
    }

    private void updateObraFromDTO(Obra obra, ObraDTO obraDTO) {
<span class="fc" id="L86">        obra.setTitulo(obraDTO.getTitulo());</span>
<span class="fc" id="L87">        obra.setFoto(obraDTO.getFoto());</span>
<span class="fc" id="L88">        obra.setLicitacao(obraDTO.getLicitacao());</span>
<span class="fc" id="L89">        obra.setDataCertame(obraDTO.getDataCertame());</span>
<span class="fc" id="L90">        obra.setValorEdital(obraDTO.getValorEdital());</span>
<span class="fc" id="L91">        obra.setBairro(obraDTO.getBairro());</span>
<span class="fc" id="L92">        obra.setRua(obraDTO.getRua());</span>
<span class="fc" id="L93">        obra.setNumeroEndereco(obraDTO.getNumero());</span>
<span class="fc" id="L94">        obra.setValorContratado(obraDTO.getValorContratado());</span>
<span class="fc" id="L95">        obra.setDataInicio(obraDTO.getDataInicio());</span>
<span class="fc" id="L96">        obra.setDataTermino(obraDTO.getDataTermino());</span>
<span class="fc" id="L97">        obra.setNumeroContrato(obraDTO.getNumeroContrato());</span>
<span class="fc" id="L98">        obra.setEmpresaContratada(obraDTO.getEmpresaContratada());</span>
<span class="fc" id="L99">        obra.setSituacao(obraDTO.getSituacao());</span>
<span class="fc" id="L100">        obra.setTipoObra(obraDTO.getTipoObra());</span>
<span class="fc" id="L101">    }</span>

    public void atualizarPeriodosObra(Obra obra) {
<span class="nc" id="L104">        final Obra obraId = obraRepository.findById(obra.getId()).orElse(null);</span>
<span class="nc" id="L105">        LocalDate dataInicio = obra.getDataInicio();</span>
<span class="nc" id="L106">        LocalDate dataTermino = obra.getDataTermino();</span>


<span class="nc" id="L109">        List&lt;Periodo&gt; periodos = new ArrayList&lt;&gt;();</span>
<span class="nc" id="L110">        DateTimeFormatter formatter = DateTimeFormatter.ofPattern(&quot;MMMM yyyy&quot;, new Locale(&quot;pt&quot;, &quot;BR&quot;));</span>

<span class="nc" id="L112">        YearMonth mesAnoInicio = YearMonth.from(dataInicio);</span>
<span class="nc" id="L113">        YearMonth mesAnoTermino = YearMonth.from(dataTermino);</span>

<span class="nc bnc" id="L115" title="All 2 branches missed.">        while (!mesAnoInicio.isAfter(mesAnoTermino)) {</span>
<span class="nc" id="L116">            Periodo periodo = new Periodo();</span>
<span class="nc" id="L117">            periodo.setMes(Meses.valueOf(mesAnoInicio.getMonth().getDisplayName(TextStyle.FULL, new Locale(&quot;pt&quot;, &quot;BR&quot;)).toUpperCase()));</span>
<span class="nc" id="L118">            periodo.setAno(mesAnoInicio.getYear());</span>
<span class="nc" id="L119">            periodos.add(periodo);</span>
<span class="nc" id="L120">            periodoRepository.save(periodo);</span>
<span class="nc" id="L121">            mesAnoInicio = mesAnoInicio.plusMonths(1);</span>
<span class="nc" id="L122">        }</span>
<span class="nc" id="L123">        obraRepository.save(obra);</span>
<span class="nc" id="L124">    }</span>

}
</pre><div class="footer"><span class="right">Created with <a href="http://www.jacoco.org/jacoco">JaCoCo</a> 0.8.9.202303310957</span></div></body></html>